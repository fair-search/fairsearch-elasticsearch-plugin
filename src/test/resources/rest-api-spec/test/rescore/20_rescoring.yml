---
setup:
  - do:
      indices.create:
        index:  test
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 1
          mappings:
            test:
              properties:
                gender:
                  type: text
                  store: true

  - do:
      index:
        index:  test
        type:   test
        id:     1
        body:   { "name": "Pere", "city": "Berlin", "gender": "Male", "langs": "Java, Scala, Ruby" }
  - do:
      index:
        index:  test
        type:   test
        id:     2
        body:   { "name": "Maria", "city": "Barcelona", "gender": "Female", "langs": "Scala, Ruby, Python" }
  - do:
      index:
        index:  test
        type:   test
        id:     3
        body:   { "name": "Dirk", "city": "Munich", "gender": "Male", "langs": "Java, Scala, Kotlin" }
  - do:
      index:
        index:  test
        type:   test
        id:     4
        body:   { "name": "John", "city": "Berlin", "gender": "Male", "langs": "Java" }
  - do:
      index:
        index:  test
        type:   test
        id:     5
        body:   { "name": "Ben", "city": "Berlin", "gender": "Male", "langs": "Ruby" }
  - do:
      index:
        index:  test
        type:   test
        id:     6
        body:   { "name": "Max", "city": "Berlin", "gender": "Male", "langs": "Java, Scala"}
  - do:
      index:
        index:  test
        type:   test
        id:     7
        body:   { "name": "Jonas", "city": "Barcelona", "gender": "Male", "langs": "Java, Scala, Ruby" }
  - do:
      index:
        index:  test
        type:   test
        id:     8
        body:   { "name": "Moritz", "city": "Munich", "gender": "Male", "langs": "Ruby, Python" }
  - do:
      index:
        index:  test
        type:   test
        id:     9
        body:   { "name": "Mia", "city": "Berlin", "gender": "Female", "langs": "Java" }
  - do:
      index:
        index:  test
        type:   test
        id:     10
        body:   { "name": "Hannah", "city": "Berlin", "gender": "Female", "langs": "Scala, Kotlin, Java" }
  - do:
      index:
        index:  test
        type:   test
        id:     11
        body:   { "name": "Anna", "city": "Berlin", "gender": "Female", "langs": "Scala, Kotlin, Java" }
  - do:
      fs.create_table:
        name: "test"
        proportion: 0.5
        alpha: 0.1
        k: 5
  - do:
      fs.create_table:
        name: "test"
        proportion: 0.99
        alpha: 0.1
        k: 5
  - do:
      indices.refresh: {}


---
"java developers":
  - do:
      search:
        index: test
        body:
          rescore:
            fair_rescorer:
              protected_key: gender
              protected_value: Female
              significance_level: 0.1
              min_proportion_protected: 0.5

  - length: { hits.hits: 10 }
  - match:  { hits.hits.0._score: 5 }
  - match:  { hits.hits.0._source: { "name": "Maria", "city": "Barcelona", "gender": "Female", "langs": "Scala, Ruby, Python" } }
  - match:  { hits.hits.1._score: 4 }
  - match:  { hits.hits.1._source: { "name": "Hannah", "city": "Berlin", "gender": "Female", "langs": "Scala, Kotlin, Java" } }
  - match:  { hits.hits.2._score: 3 }
  - match:  { hits.hits.2._source: { "name": "Mia", "city": "Berlin", "gender": "Female", "langs": "Java" } }
  - match:  { hits.hits.3._score: 2 }
  - match:  { hits.hits.3._source:  { "name": "Pere", "city": "Berlin", "gender": "Male", "langs": "Java, Scala, Ruby" } }
  - match:  { hits.hits.4._score: 1 }
  - match:  { hits.hits.4._source: { "name": "Moritz", "city": "Munich", "gender": "Male", "langs": "Ruby, Python" } }
  - match:  { hits.hits.5._score: 0 }
---
"abort rescoring":
  - do:
     catch: request
     search:
        index: test
        body:
          rescore:
            fair_rescorer:
              protected_key: gender
              protected_value: Female
              min_proportion_protected: 0.99
              on_few_protected_elements: "abort"
